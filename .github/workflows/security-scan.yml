name: Security CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Secret Scanning with TruffleHog
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Get full history
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          # Scan the entire repository, not just changes
          extra_args: --only-verified --json

  # Job 2: SAST with Semgrep
  sast-scan:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten

  # Job 3: Container Scanning with Trivy
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image
        run: docker build -t secure-app:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner (Table Output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secure-app:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Run Trivy and generate SARIF report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: secure-app:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job 4: Security Summary
  security-summary:
    name: Security Report Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, container-scan]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Detection: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SAST Analysis: ${{ needs.sast-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Container Scan: ${{ needs.container-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the job logs above â˜ï¸" >> $GITHUB_STEP_SUMMARY
