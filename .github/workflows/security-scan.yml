name: Security CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  secret_scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install TruffleHog
        run: pip install trufflehog

      - name: Run TruffleHog (filesystem)
        run: |
          trufflehog filesystem --fail --json . || (echo "TruffleHog found potential secrets" && exit 1)

  semgrep:
    name: Semgrep SAST Scan
    needs: secret_scan
    runs-on: ubuntu-latest

    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep (with OWASP & CWE rules)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/cwe-top-25
        continue-on-error: false

  trivy:
    name: Trivy Container Scan
    needs: [secret_scan, semgrep]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t secure-cicd-demo:latest .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "secure-cicd-demo:latest"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "1"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
